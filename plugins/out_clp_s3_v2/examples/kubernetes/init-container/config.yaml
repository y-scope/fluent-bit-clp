# =============================================================================
# Fluent Bit Configuration for Init Container Deployment
# =============================================================================
# This ConfigMap is used with the init-container deployment pattern.
# The only difference from the quickstart config is the plugin path:
#   - quickstart: /fluent-bit/plugins/ (baked into image)
#   - init-container: /fluent-bit/plugins/ (downloaded to emptyDir volume)
#
# Both use the same path because the init container downloads the plugin
# to an emptyDir volume mounted at /fluent-bit/plugins/
# =============================================================================

apiVersion: "v1"
kind: "ConfigMap"
metadata:
  name: "fluent-bit-config"
data:
  fluent-bit.yaml: |
    # -------------------------------------------------------------------------
    # Plugins
    # -------------------------------------------------------------------------
    # Load the CLP plugin downloaded by the init container
    # The init container saves it to an emptyDir mounted at /fluent-bit/plugins/
    plugins:
      - "/fluent-bit/plugins/out_clp_s3_v2.so"

    # -------------------------------------------------------------------------
    # Service
    # -------------------------------------------------------------------------
    service:
      flush: 1
      daemon: "off"
      log_level: "info"

    # -------------------------------------------------------------------------
    # Pipeline
    # -------------------------------------------------------------------------
    pipeline:
      inputs:
        - name: "tail"
          # Watch for .jsonl files in subdirectories of /var/log
          path: "/var/log/*/*.jsonl"
          path_key: "file_path"
          # Extract folder name and filename as tag components
          tag_regex: "^\\/var\\/log\\/(?<user_name>[^\\/]+)\\/(?<file_name>.*\\.jsonl)$"
          tag: "<user_name>/<file_name>"
          refresh_interval: 5
          read_from_head: true
          key: "message"
          buffer_max_size: "1MB"

      outputs:
        - name: "out_clp_s3_v2"
          match: "*/*"
          log_bucket: "logs"
