# =============================================================================
# DaemonSet with Init Container: Downloads plugin at pod startup
# =============================================================================
# This example uses an INIT CONTAINER to download the CLP plugin from GitHub
# Releases before the main Fluent Bit container starts.
#
# Init Container Concept:
#   - Init containers run BEFORE the main containers start
#   - They run to completion (must exit successfully)
#   - Main containers only start after ALL init containers succeed
#   - Useful for: downloading files, waiting for services, setup tasks
#
# Flow:
#   1. Pod starts → Init container runs
#   2. Init container downloads plugin to shared volume → exits
#   3. Fluent Bit container starts → loads plugin from shared volume
#
# When to use this approach:
#   - You want to use a specific plugin version
#   - You need to combine multiple plugins
#   - You prefer the official Fluent Bit base image
#
# Trade-off: Potential GLIBC compatibility issues between plugin and base image
# =============================================================================

apiVersion: "apps/v1"
kind: "DaemonSet"
metadata:
  name: "fluent-bit"
  labels:
    k8s-app: "fluent-bit"
spec:
  selector:
    matchLabels:
      k8s-app: "fluent-bit"
  template:
    metadata:
      labels:
        k8s-app: "fluent-bit"
    spec:
      serviceAccountName: "fluent-bit"

      # -----------------------------------------------------------------------
      # Init Containers
      # -----------------------------------------------------------------------
      # These run BEFORE the main containers and must complete successfully
      initContainers:
        - name: "download-plugin"
          # busybox: Minimal image with wget for downloading
          image: "busybox:1.36"

          env:
            - name: "PLUGIN_VERSION"
              # "latest" downloads the most recent release
              # For reproducible builds, pin to a specific version: "v0.1.0"
              value: "latest"

          # Shell script to download the correct plugin for this architecture
          command:
            - "sh"
            - "-c"
            - |
              # Detect CPU architecture (handles mixed clusters: amd64 + arm64)
              ARCH=$(uname -m)
              case "${ARCH}" in
                x86_64)  PLUGIN_ARCH="amd64" ;;
                aarch64) PLUGIN_ARCH="arm64" ;;
                *)       echo "Unsupported architecture: ${ARCH}"; exit 1 ;;
              esac

              # Construct download URL
              PLUGIN_FILE="out_clp_s3_v2_linux_${PLUGIN_ARCH}.so"
              BASE_URL="https://github.com/y-scope/fluent-bit-clp"
              PLUGIN_URL="${BASE_URL}/releases/${PLUGIN_VERSION}/download/${PLUGIN_FILE}"

              echo "Downloading plugin from: ${PLUGIN_URL}"

              # Download to the shared volume (mounted at /plugins)
              # The main container will mount this same volume at /fluent-bit/plugins
              wget -O "/plugins/out_clp_s3_v2.so" "${PLUGIN_URL}"
              chmod 755 "/plugins/out_clp_s3_v2.so"

          volumeMounts:
            # Write downloaded plugin to this shared volume
            - name: "plugins-volume"
              mountPath: "/plugins"

      # -----------------------------------------------------------------------
      # Main Containers
      # -----------------------------------------------------------------------
      containers:
        - name: "fluent-bit"
          # Official Fluent Bit image (plugin loaded separately)
          image: "fluent/fluent-bit:3.2.7"
          args: ["-c", "/fluent-bit/etc/fluent-bit.yaml"]

          env:
            - name: "AWS_ENDPOINT_URL"
              # MinIO endpoint for local testing
              # REMOVE this env var entirely when using real AWS S3
              value: "http://minio:9000"

          resources:
            limits:
              memory: "100Mi"
            requests:
              cpu: "100m"
              memory: "100Mi"

          volumeMounts:
            # Host log directories
            - name: "varlog"
              mountPath: "/var/log"
            - name: "varlibdockercontainers"
              mountPath: "/var/lib/docker/containers"
              readOnly: true

            # AWS credentials
            - name: "aws-credentials-volume"
              mountPath: "/root/.aws"

            # Fluent Bit config
            - name: "config-volume"
              mountPath: "/fluent-bit/etc"

            # Plugin downloaded by init container
            # The init container wrote to /plugins, we mount it at /fluent-bit/plugins
            - name: "plugins-volume"
              mountPath: "/fluent-bit/plugins"
              readOnly: true

      # -----------------------------------------------------------------------
      # Volumes
      # -----------------------------------------------------------------------
      volumes:
        - name: "varlog"
          hostPath:
            path: "/var/log"

        - name: "varlibdockercontainers"
          hostPath:
            path: "/var/lib/docker/containers"

        - name: "aws-credentials-volume"
          secret:
            secretName: "aws-credentials"

        - name: "config-volume"
          configMap:
            name: "fluent-bit-config"

        # emptyDir: Shared storage between init container and main container
        # - Init container downloads plugin here
        # - Main container reads plugin from here
        # - Deleted when pod terminates
        - name: "plugins-volume"
          emptyDir: {}
