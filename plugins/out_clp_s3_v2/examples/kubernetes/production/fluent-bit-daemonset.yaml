# =============================================================================
# Production DaemonSet: Node-level log collection
# =============================================================================
# Runs one Fluent Bit pod on every node to collect logs from all containers.
# Uses the pre-built image with CLP plugin bundled.
#
# For detailed explanations of DaemonSets and Kubernetes concepts,
# see: ../quickstart/daemonset.yaml
# =============================================================================

apiVersion: "apps/v1"
kind: "DaemonSet"
metadata:
  name: "fluent-bit"
  labels:
    k8s-app: "fluent-bit"
spec:
  selector:
    matchLabels:
      k8s-app: "fluent-bit"
  template:
    metadata:
      labels:
        k8s-app: "fluent-bit"
    spec:
      serviceAccountName: "fluent-bit"

      containers:
        - name: "fluent-bit"
          # Pre-built image includes CLP plugin at /fluent-bit/plugins/
          # Build locally: ./scripts/build-docker.sh
          image: "ghcr.io/y-scope/fluent-bit-clp-s3-v2:latest"
          args: ["-c", "/fluent-bit/etc/fluent-bit.yaml"]

          env:
            - name: "AWS_ENDPOINT_URL"
              # REMOVE this line for real AWS S3
              # Only needed for MinIO or S3-compatible storage
              value: "http://minio:9000"

          resources:
            # Adjust based on log volume
            limits:
              memory: "100Mi"
            requests:
              cpu: "100m"
              memory: "100Mi"

          volumeMounts:
            # Host log directory - access logs from all pods on this node
            - name: "varlog"
              mountPath: "/var/log"
            - name: "varlibdockercontainers"
              mountPath: "/var/lib/docker/containers"
              readOnly: true
            # AWS credentials
            - name: "aws-credentials-volume"
              mountPath: "/root/.aws"
            # Fluent Bit config
            - name: "config-volume"
              mountPath: "/fluent-bit/etc"

      volumes:
        # hostPath: Mount directories from the node's filesystem
        - name: "varlog"
          hostPath:
            path: "/var/log"
        - name: "varlibdockercontainers"
          hostPath:
            path: "/var/lib/docker/containers"
        # Secret: AWS credentials
        - name: "aws-credentials-volume"
          secret:
            secretName: "aws-credentials"
        # ConfigMap: Fluent Bit configuration
        - name: "config-volume"
          configMap:
            name: "fluent-bit-config"
