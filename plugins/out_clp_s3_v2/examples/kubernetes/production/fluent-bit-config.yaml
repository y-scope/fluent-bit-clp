apiVersion: "v1"
kind: "ConfigMap"
metadata:
  name: "fluent-bit-config"
data:
  fluent-bit.yaml: |
    plugins:
      - "/fluent-bit/plugins/out_clp_s3_v2.so"

    service:
      flush: 1
      daemon: "off"
      log_level: "info"

    parsers:
      - name: "json"
        format: "json"
        json_error_key: "message"

    pipeline:
      inputs:
        - name: "tail"
          path: "/logs/*/*.jsonl"
          parser: json
          path_key: "file_path"
          tag_regex: "^\\/logs\\/(?<user_name>[^\\/]+)\\/(?<file_name>.*\\.jsonl)$"
          tag: "<user_name>/<file_name>"
          refresh_interval: 5
          read_from_head: true
          key: "message"
          buffer_max_size: "1MB"

      filters:
        - name: "modify"
          match: "*"
          Add:
            - "level INFO"

      outputs:
        - name: "out_clp_s3_v2"
          match: "*/*"
          log_bucket: "logs"
          log_level_key: "level"
