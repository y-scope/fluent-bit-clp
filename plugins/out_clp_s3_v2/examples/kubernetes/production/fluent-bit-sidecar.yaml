# =============================================================================
# Production Sidecar: Per-pod log collection
# =============================================================================
# Fluent Bit runs alongside your application in the same pod.
# Both containers share a volume for log files.
# Uses the pre-built image with CLP plugin bundled.
#
# For detailed explanations of sidecars and Kubernetes concepts,
# see: ../quickstart/sidecar.yaml
# =============================================================================

apiVersion: "v1"
kind: "Pod"
metadata:
  labels:
    app: "fluent-bit-sidecar"
  name: "fluent-bit-sidecar"
spec:
  containers:
    # -------------------------------------------------------------------------
    # Your Application Container
    # -------------------------------------------------------------------------
    # Replace this with your actual application
    - name: "app"
      image: "ubuntu:22.04"
      command: ["sleep", "infinity"]
      volumeMounts:
        # App writes logs here
        - name: "log-volume"
          mountPath: "/logs"

    # -------------------------------------------------------------------------
    # Fluent Bit Sidecar
    # -------------------------------------------------------------------------
    - name: "fluent-bit"
      # Pre-built image includes CLP plugin at /fluent-bit/plugins/
      image: "ghcr.io/y-scope/fluent-bit-clp-s3-v2:latest"
      args: ["-c", "/fluent-bit/etc/fluent-bit.yaml"]

      env:
        - name: "AWS_ENDPOINT_URL"
          # REMOVE for real AWS S3
          value: "http://minio:9000"

      volumeMounts:
        # Same volume as app - reads logs written by app
        - name: "log-volume"
          mountPath: "/logs"
          readOnly: true
        - name: "aws-credentials-volume"
          mountPath: "/root/.aws"
          readOnly: true
        - name: "config-volume"
          mountPath: "/fluent-bit/etc"
          readOnly: true

  volumes:
    - name: "aws-credentials-volume"
      secret:
        secretName: "aws-credentials"
    - name: "config-volume"
      configMap:
        name: "fluent-bit-config"
    # emptyDir: Shared storage between app and Fluent Bit
    - name: "log-volume"
      emptyDir: {}
