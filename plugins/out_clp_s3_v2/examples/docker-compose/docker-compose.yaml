# Docker Compose for local development and testing
# Usage: docker compose up
#
# Services:
#   - minio: S3-compatible storage (console at http://localhost:9001)
#   - fluent-bit: Log collector with CLP plugin
#   - log-generator: Generates sample logs for testing
#
# View logs: http://localhost:9000/log-viewer/index.html

services:
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # Console
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
      MINIO_API_CORS_ALLOW_ORIGIN: "*"
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5

  minio-setup:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 minioadmin minioadmin;
      mc mb local/logs --ignore-existing;
      mc anonymous set download local/logs;
      echo 'Bucket created successfully';
      "

  # Deploys YScope Log Viewer to MinIO for viewing compressed logs
  log-viewer-setup:
    image: amazon/aws-cli:latest
    depends_on:
      minio-setup:
        condition: service_completed_successfully
    environment:
      AWS_ENDPOINT_URL: http://minio:9000
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      LOG_VIEWER_BUCKET: log-viewer
    entrypoint: >
      /bin/bash -c "
      yum install -y -q gzip jq tar &&
      curl -s https://raw.githubusercontent.com/y-scope/yscope-log-viewer/refs/heads/main/tools/deployment/s3/deploy.sh | bash
      "

  fluent-bit:
    # Pre-built image (uncomment when available):
    # image: ghcr.io/y-scope/fluent-bit-clp-s3-v2:latest
    # Build locally:
    platform: ${PLATFORM:-linux/amd64}
    build:
      context: ../../../..
      dockerfile: plugins/out_clp_s3_v2/Dockerfile
    depends_on:
      minio-setup:
        condition: service_completed_successfully
    environment:
      AWS_REGION: us-east-1
      AWS_ENDPOINT_URL: http://minio:9000
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
    volumes:
      - ./fluent-bit.yaml:/fluent-bit/etc/fluent-bit.yaml:ro
      - logs:/logs:ro
    restart: unless-stopped

  # Optional: generates sample logs for testing
  log-generator:
    image: alpine:latest
    volumes:
      - logs:/logs
    entrypoint: >
      /bin/sh -c "
      mkdir -p /logs/app;
      echo 'Starting log generator...';
      i=0;
      while true; do
        timestamp=$$(date -u +%Y-%m-%dT%H:%M:%SZ);
        level=$$(shuf -n1 -e debug info info info warn error);
        echo \"{\\\"timestamp\\\":\\\"$$timestamp\\\",\\\"level\\\":\\\"$$level\\\",\\\"message\\\":\\\"Log message $$i from container\\\",\\\"service\\\":\\\"app\\\"}\" >> /logs/app/test-$$(date +%Y%m%d).jsonl;
        i=$$((i + 1));
        sleep 1;
      done
      "

volumes:
  minio-data:
  logs:
