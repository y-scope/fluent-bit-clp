apiVersion: "v1"
kind: "Pod"
metadata:
  labels:
    app: "fluent-bit-sidecar-full"
  name: "fluent-bit-sidecar-full"
spec:
  containers:
    - name: "ubuntu"
      image: "ubuntu:22.04"
      command: ["sleep", "infinity"]
      volumeMounts:
        - name: "log-volume"
          mountPath: "/logs"

    # Fluent-bit sidecar
    - name: "fluent-bit-sidecar"
      image: "fluent/fluent-bit:3.2.7"
      args: ["-c", "/fluent-bit/etc/fluent-bit.yaml"]
      env:
        - name: "AWS_ENDPOINT_URL"
          value: "http://minio:9000"
      volumeMounts:
        - name: "log-volume"
          mountPath: "/logs"
          readOnly: true
        - name: "aws-credentials-volume"
          mountPath: "/root/.aws"
          readOnly: true
        - name: "config-volume"
          mountPath: "/fluent-bit/etc"
          readOnly: true
        - name: "plugins-volume"
          mountPath: "/fluent-bit/plugins"
          readOnly: true
      imagePullPolicy: "IfNotPresent"
  volumes:
    - name: "aws-credentials-volume"
      secret:
        secretName: "aws-credentials"
    - name: "config-volume"
      configMap:
        name: "fluent-bit-sidecar-config-full"
    - name: "plugins-volume"
      hostPath:
        path: "/fluent-bit/plugins"
    - name: "log-volume"
      emptyDir: {}
