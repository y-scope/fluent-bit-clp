apiVersion: "v1"
kind: "ConfigMap"
metadata:
  name: "fluent-bit-sidecar-config"
data:
  fluent-bit.yaml: |
    plugins:
      - "/fluent-bit/plugins/out_clp_s3_v2_linux_amd64.so"

    service:
      flush: 1
      daemon: "off"
      log_level: "trace"

    parsers:
      - name: "json"
        format: "json"
        json_error_key: "message"

    pipeline:
      inputs:
        - name: "tail"
          path: "/logs/*/test-*.jsonl"
          parser: json
          path_key: "file_path"
          tag_regex: "^\/logs\/(?<user_name>[^\/]+)\/(?<file_name>test-.*\\.jsonl)$"
          tag: "<user_name>/<file_name>"
          # The interval of refreshing the list of watched files in seconds
          refresh_interval: 5
          # For new discovered files on start (without a database offset/position),
          # read the content from the head of the file, not tail.
          read_from_head: true
          # When a message is unstructured (no parser applied), it's appended as a string under the key
          # name log. This option allows defining an alternative name for that key.
          key: "message"
          buffer_max_size: "1MB"
          processors: []

      filters:
        - name: "modify"
          match: "*"
          Add:
            - "level INFO"
    
      outputs:
        - name: "out_clp_s3_v2"
          match: "*/*"
          log_bucket: "logs"