# Docker Compose for local development and testing
# Usage: docker compose up
#
# Services:
#   - minio: S3-compatible storage (console at http://localhost:9001)
#   - fluent-bit: Log collector with CLP plugin
#   - log-generator: Generates sample logs for testing

services:
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # Console
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5

  minio-setup:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 minioadmin minioadmin;
      mc mb local/logs --ignore-existing;
      mc anonymous set download local/logs;
      echo 'Bucket created and configured';
      "

  fluent-bit:
    # Pre-built image (uncomment when available):
    # image: ghcr.io/y-scope/fluent-bit-clp-s3:latest
    # Build locally:
    build:
      context: ../../../..
      dockerfile: plugins/out_clp_s3/Dockerfile
    depends_on:
      minio-setup:
        condition: service_completed_successfully
    environment:
      AWS_REGION: us-east-1
      AWS_ENDPOINT_URL: http://minio:9000
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
    volumes:
      - ./fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf:ro
      - logs:/logs:ro
    restart: unless-stopped

  # Generates sample logs for testing
  log-generator:
    image: alpine:latest
    volumes:
      - logs:/logs
    entrypoint: >
      /bin/sh -c "
      mkdir -p /logs;
      echo 'Starting log generator...';
      i=0;
      while true; do
        ts=$$(date -u +%Y-%m-%dT%H:%M:%SZ);
        echo \"$$ts INFO Log message $$i from container\" >> /logs/app.log;
        i=$$((i + 1));
        sleep 0.1;
      done
      "

volumes:
  minio-data:
  logs:
