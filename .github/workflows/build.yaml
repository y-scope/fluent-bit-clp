name: "build"

on:
  push:
  pull_request:

env:
  REGISTRY: "ghcr.io"

jobs:
  build-plugins:
    runs-on: "${{ matrix.runner }}"
    strategy:
      matrix:
        include:
          - arch: "amd64"
            runner: "ubuntu-24.04"
            manylinux: "quay.io/pypa/manylinux_2_28_x86_64"
          - arch: "arm64"
            runner: "ubuntu-24.04-arm"
            manylinux: "quay.io/pypa/manylinux_2_28_aarch64"
    steps:
      - uses: "actions/checkout@v4"
        with:
          submodules: "recursive"

      # Build inside manylinux container for glibc compatibility
      - name: "Build plugins"
        run: |
          docker run --rm -v "${{ github.workspace }}:/src" -w /src ${{ matrix.manylinux }} bash -c '
            set -e

            # Install git (required for download-libs.sh to detect commit hash)
            yum install -y git

            # Install Go
            curl -fsSL "https://go.dev/dl/go1.24.3.linux-${{ matrix.arch }}.tar.gz" | tar -C /usr/local -xz
            export PATH="/usr/local/go/bin:$PATH"

            # Install task
            curl -fsSL https://taskfile.dev/install.sh | sh -s -- -d -b /usr/local/bin

            # Download clp-ffi-go libraries
            bash third-party/clp-ffi-go/scripts/download-libs.sh

            # Build plugins
            task build:s3
            task build:s3v2
          '

      - name: "Upload artifacts"
        uses: "actions/upload-artifact@v4"
        with:
          name: "fluent-bit-clp-plugins-${{ matrix.arch }}"
          path: "pre-built/*.so"

  merge-artifacts:
    runs-on: "ubuntu-24.04"
    needs: "build-plugins"
    steps:
      - name: "Download all artifacts"
        uses: "actions/download-artifact@v4"
        with:
          path: "plugins"
          pattern: "fluent-bit-clp-plugins-*"
          merge-multiple: true

      - name: "Upload merged artifact"
        uses: "actions/upload-artifact@v4"
        with:
          name: "fluent-bit-clp-plugins"
          path: "plugins/*.so"

      - name: "Delete arch-specific artifacts"
        uses: "geekyeggo/delete-artifact@v5"
        with:
          name: "fluent-bit-clp-plugins-*"

  release:
    if: "github.event_name == 'push'"
    needs: "merge-artifacts"
    runs-on: "ubuntu-24.04"
    permissions:
      contents: "write"
    steps:
      - uses: "actions/checkout@v4"

      - name: "Download merged artifacts"
        uses: "actions/download-artifact@v4"
        with:
          name: "fluent-bit-clp-plugins"
          path: "plugins"

      - name: "Get short commit hash"
        id: "commit"
        run: "echo \"hash=$(git rev-parse --short HEAD)\" >> \"$GITHUB_OUTPUT\""

      - name: "Create release"
        env:
          GH_TOKEN: "${{ github.token }}"
        run: |
          gh release create "${{ steps.commit.outputs.hash }}" \
            --title "Build ${{ steps.commit.outputs.hash }}" \
            --notes "Pre-built Fluent Bit CLP plugins for commit ${{ steps.commit.outputs.hash }}" \
            plugins/*.so

  build-docker:
    runs-on: "ubuntu-24.04"
    permissions:
      contents: "read"
      packages: "write"
    strategy:
      matrix:
        include:
          - plugin: "out_clp_s3"
            image: "fluent-bit-clp-s3"
            platforms: "linux/amd64,linux/arm64"
          - plugin: "out_clp_s3_v2"
            image: "fluent-bit-clp-s3-v2"
            platforms: "linux/amd64,linux/arm64"
    steps:
      - uses: "actions/checkout@v4"
        with:
          submodules: "recursive"

      - name: "Set up QEMU"
        uses: "docker/setup-qemu-action@v3"

      - name: "Set up Docker Buildx"
        uses: "docker/setup-buildx-action@v3"

      - name: "Log in to GitHub Container Registry"
        uses: "docker/login-action@v3"
        with:
          registry: "${{ env.REGISTRY }}"
          username: "${{ github.actor }}"
          password: "${{ secrets.GITHUB_TOKEN }}"

      - name: "Extract metadata"
        id: "meta"
        uses: "docker/metadata-action@v5"
        with:
          images: "${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ matrix.image }}"
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: "Build and push"
        uses: "docker/build-push-action@v6"
        with:
          context: "."
          file: "plugins/${{ matrix.plugin }}/Dockerfile"
          platforms: "${{ matrix.platforms }}"
          push: "${{ github.event_name == 'push' }}"
          tags: "${{ steps.meta.outputs.tags }}"
          labels: "${{ steps.meta.outputs.labels }}"
